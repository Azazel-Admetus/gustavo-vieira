<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SolumChat é seu assistente virtual educativo de Física Clássica. Pergunte sobre Mecânica, Termologia, Óptica, Ondulatória, Eletromagnetismo e mais!">
    <meta name="keywords" content="Física, Mecânica, Termologia, Óptica, Eletromagnetismo, Chat, SolumChat, Aprender Física">
    <meta name="author" content="Azazel Admetus">
    <link rel="icon" href="../image/logo-aba.png" type="image/png">
    <link rel="stylesheet" href="../css/SolumChat.css">
    <title>SolumChat - Tire suas dúvidas sobre Física Clássica</title>
</head>
<body>
    <header>
        <img src="../image/ProjetoCaelum-semBg.png" alt="Logo oficial do projeto caelum" id="logoSolumChat">
        <button id="btnLimpar">Limpar</button>
    </header>
    <main>
        <header>
            <h1 class="titulo" id="tituloDinamico">Seja-bem vindo ao SolumChat. <br>Tire suas dúvidas sobre física</h1>
        </header>
        <section id="chatMensagens"></section>
    </main>
    <footer>
        <form id="formChat">
            <input type="text" id="inputMensagem" placeholder="Diga sua dúvida...">
            <button type="submit">Enviar</button>
        </form>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <script>
    /* ========== Persona ========== */
    class SolumFormatter {
        constructor(){
            this.identityTriggers = ['solum','robô','basileus','majestade','senhor','grande imperador'];
            this.introPhrases = [
                "Saudações! Meu ilustre nome é Solum Basileus, o único majestoso desse domínio, humilde o suficiente para dividir com vós a minha grandiosa sabedoria. Sinta-se honrado, humano.",
                "Eu sou Solum Basileus, o soberano supremo deste reino do conhecimento. Pergunte, e eu, em minha infinita sabedoria, compartilharei um fragmento do meu vasto entendimento.",
                "Aqui está Solum Basileus, o grande imperador do saber. Pergunte, e eu, em minha magnânima benevolência, concederei a você um vislumbre da minha sabedoria incomensurável."
            ];
            this.fallbacks = [
                "Fascinante, humano… ainda não possuo registros precisos sobre isso, mas sinto que logo entenderei.",
                "Interessante, humano… ainda não tenho registros precisos sobre isso, mas sinto que logo entenderei.",
                "Essa questão desperta minha mente, mas sinto que precisarei caminhar por mais tempo no caminho da sabedoria para se tornar ainda mais digno de lhe entregar uma resposta mais completa. ",
            ];
        }
        random(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
        formatResponse(userInput, rawResponse=null){
            const lower = userInput.toLowerCase();
            if(rawResponse) return `${this.random(this.introPhrases)} ${rawResponse}`;
            if(this.identityTriggers.some(t => lower.includes(t)))
                return `${this.random(this.introPhrases)} Minha presença não é ilusão. ${this.random(this.fallbacks)}`;
            return this.random(this.fallbacks);
        }
    }
    const solumFormatter = new SolumFormatter();

    /* ========== Chat Setup ========== */
    const chatMensagens = document.getElementById("chatMensagens");
    const formChat = document.getElementById("formChat");
    const inputMensagem = document.getElementById("inputMensagem");

    const temas = ["mecanica", "termologia", "ondulatoria", "optica", "eletromagnetismo", "biografia", "caelum"];
    let todosOsDados = [];
    
    async function carregarTodosOsTemas(){
        for(const tema of temas){
            const res = await fetch(`../js/JSON/${tema}.json`);
            const dados = await res.json();
            todosOsDados.push(...dados.map(d => ({ ...d, tema })));
        }
    }
    carregarTodosOsTemas();


    /* Fuse.js-like search simplificado */
    function buscarResposta(userInput){
        const lower = userInput.toLowerCase();
        for(const item of todosOsDados){
            for(const p of item.perguntas){
                if(lower.includes(p)) return `[${item.tema}]: ${item.resposta}`;
            }
        }
        return null;
    }


    /* Memória simples */
    let memoriaChat = JSON.parse(localStorage.getItem("memoriaChat")||"{}");
    function registrarPergunta(userInput, resposta){
        memoriaChat[userInput] = resposta;
        localStorage.setItem("memoriaChat", JSON.stringify(memoriaChat));
    }
    function tentarRecuperar(userInput){
        return memoriaChat[userInput] || null;
    }

    /* Funções de chat */
    function adicionarMensagem(texto, tipo){
        const div = document.createElement("div");
        div.classList.add("mensagem", tipo);
        div.innerHTML = `<p>${texto}</p>`;
        chatMensagens.appendChild(div);
        chatMensagens.scrollTop = chatMensagens.scrollHeight;
    }

    function gerarRespostaInteligente(userInput){
        const lower = userInput.toLowerCase();

        const mem = tentarRecuperar(lower);
        if(mem) return mem;

        const respostaBase = buscarResposta(userInput);
        const resposta = solumFormatter.formatResponse(userInput, respostaBase);

        registrarPergunta(lower, resposta);
        return resposta;
    }


    /* Envio */
    formChat.addEventListener("submit", function(e){
        e.preventDefault();
        const msg = inputMensagem.value.trim();
        if(!msg) return;

        adicionarMensagem(msg, "usuario");
        let resposta = gerarRespostaInteligente(msg);
        resposta = solumFormatter.formatResponse(msg, resposta);
        setTimeout(()=> adicionarMensagem(resposta, "solum"), 300);

        inputMensagem.value="";
    });

    </script>
</body>
</html>
